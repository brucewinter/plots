function plotit() {
    var loadCount = 0;
    var series = [];
    var lasttime = moment();
    var refresh = 0;
    var graph;
    setInterval(function(){loadRefresh()}, 120000);
    loadLoop();
}

function loadLoop() {
    var h = 48 - 6*loadCount;
//  var starttime = moment().subtract(h, "hours").fromNow();
    var starttime = moment().subtract(h, "hours").startOf('hour');
    var query = { 
	datastreams: channels,
	start: starttime.toJSON(), 
        duration: '6hours',
	interval: 120, 
	limit: 1000,
    };
    console.log(loadCount, h, query);
    xively.feed.history(feed, query, loadData); 
}


function loadRefresh() {
    var stoptime  = moment();
    var starttime = lasttime;
    var query = { 
	datastreams: channels,
	start: starttime.toJSON(), 
	stop:  stoptime.toJSON(), 
	interval: 120, 
	limit: 1000,
    };
    refresh = 1;
    xively.feed.history(feed, query, loadData); 
    var t = moment().format("h:mmA");
    document.getElementById("lastupdate").innerHTML = "Updated:" + t;
}

function loadData(data) {  
    var palette = new Rickshaw.Color.Palette();
    var filtedData1 = data.datastreams;

// Find channel with minimum number of datapoints ... series must have the same number of points.  zeroFill is yucky.

    for (var i1=0; i1 < filtedData1.length; i1++ ) {
	var filtedData2 = filtedData1[i1].datapoints;
	var id = filtedData1[i1].id;
	if (filtedData2 && filtedData2.length) {
	    if (loadCount == 0) {
		var id = filtedData1[i1].id;
		if (id == 'TempWW1') {id = '0Feet'}
		if (id == 'TempWW2') {id = '2Feet'}
		if (id == 'TempWW3') {id = '4Feet'}
		if (id == 'TempWW4') {id = '7Foot'}
		if (id == 'TempWW5') {id = '12Foot'}
		if (id == 'Temperature2') {id = 'Downstairs'}
		if (id == 'Temperature3') {id = 'Upstairs'}
		series.push({name: id, color: palette.color(), data: []});
	    }
	    for (var i2=0; i2 < filtedData2.length; i2++ ) {
		lasttime  = moment(filtedData2[i2].at);
		var date  = moment(filtedData2[i2].at).unix();
		var value = parseFloat(filtedData2[i2].value)
		if (date && value) {
		    series[i1].data.push({x: date, y: value});
		}
	    }
	} 
    }	
   console.log("refresh", refresh, loadCount);
    if (refresh) {
	graph.update();
    }
    else if (loadCount++ < 7) {
	loadLoop();
    }
    else {
//      Rickshaw.Series.zeroFill(series);  // Will add zero values to series with missing data, otherwise plot will abort with unmatched x data.
	drawGraph(series);
    }

}

function drawGraph(data) {
//  console.log(data);
    graph = new Rickshaw.Graph( {
	element: document.querySelector("#chart"),
	width:  2400,
	height: 1400,
	min: 'auto',
	renderer: 'line',
	series: data
    } );
    graph.render();

    var resize = function() {
	graph.configure({
	    width: window.innerWidth * 0.9,
	    height: window.innerHeight * 0.9
	});
	graph.render();
    }
    window.addEventListener('resize', resize); 

//  var slider = new Rickshaw.Graph.RangeSlider.Preview({
    var slider = new Rickshaw.Graph.RangeSlider({
	graph: graph,
	element: document.getElementById('slider')
    });

    var hoverDetail = new Rickshaw.Graph.HoverDetail( {
	graph: graph
    } );

    var legend = new Rickshaw.Graph.Legend( {
	graph: graph,
	element: document.getElementById('legend')
    } );

    var shelving = new Rickshaw.Graph.Behavior.Series.Toggle( {
	graph: graph,
	legend: legend
    } );

    var axes = new Rickshaw.Graph.Axis.Time( {
	graph: graph
    });
    axes.render();

    var yAxis = new Rickshaw.Graph.Axis.Y({
	graph: graph
    });
    yAxis.render();

}
